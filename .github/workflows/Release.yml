name: Release Deployment

on:
  push:
    tags:
      - 'v*'   # Trigger on any tag starting with "v"

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1) Checkout the exact tag
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.ref }}

      # 2) Copy deployment files to EC2 runner
      - name: Copy deployment files
        run: |
          mkdir -p ~/aws-three-tier
          cp -r $GITHUB_WORKSPACE/deploy ~/aws-three-tier/

      # 3) Install systemd service (if not already installed)
      - name: Install systemd service
        run: |
          sudo cp ~/aws-three-tier/deploy/aws-three-tier.service /etc/systemd/system/aws-three-tier.service
          sudo chmod 644 /etc/systemd/system/aws-three-tier.service
          sudo systemctl daemon-reload
          sudo systemctl enable aws-three-tier

      # 4) Make deploy.sh executable
      - name: Set deploy.sh permissions
        run: sudo chmod +x ~/aws-three-tier/deploy/deploy.sh

      # 5) Restart the service
      - name: Restart Service
        run: |
          sudo systemctl restart aws-three-tier
          sudo systemctl status aws-three-tier --no-pager || true

