name: PR Report Export

on:
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Fetch PR data
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { writeFileSync } = require('fs');
            let page = 1;
            let all = [];

            while(true){
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                per_page: 100,
                page
              });
              if(prs.data.length === 0) break;
              all.push(...prs.data);
              page++;
            }

            let csv = "PR_Number,Title,Source,Target,State,Environment,Author,MergedAt\n";
            all.forEach(pr=>{
              const src = pr.head.ref;
              const tgt = pr.base.ref;
              const env = tgt === "main" || tgt === "main" ? "docker" : "dev";
              const merged = pr.merged_at ? "merged" : pr.state;
              csv += `${pr.number},"${pr.title}",${src},${tgt},${merged},${env},${pr.user.login},${pr.merged_at}\n`;
            });

            writeFileSync("pr-report.csv", csv);
