name: PR Report Export

# Trigger manually + nightly
on:
  workflow_dispatch:
  schedule:
    - cron: "20 18 * * *"  # 11:50 PM IST

permissions:
  id-token: write
  contents: read

jobs:
  export:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch today's PRs and create CSV
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { writeFileSync } = require('fs');
            const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD

            let page = 1;
            let all = [];
            while(true){
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                per_page: 100,
                page
              });
              if(prs.data.length === 0) break;
              all.push(...prs.data);
              page++;
            }

            // Today's PRs (created or updated today)
            const filtered = all.filter(pr => {
              const created = pr.created_at?.slice(0,10);
              const updated = pr.updated_at?.slice(0,10);
              return created === today || updated === today;
            });

            let csv = "PR_Number,Title,Source,Target,State,Environment,Author,MergedAt,CreatedAt,UpdatedAt\n";
            filtered.forEach(pr=>{
              const src = pr.head.ref;
              const tgt = pr.base.ref;
              const env = tgt === "main" || tgt === "master" ? "prod" : "dev";
              const merged = pr.merged_at ? "merged" : pr.state;
              csv += `${pr.number},"${pr.title}",${src},${tgt},${merged},${env},${pr.user.login},${pr.merged_at},${pr.created_at},${pr.updated_at}\n`;
            });

            const fname = `pr-report-${today}.csv`;
            writeFileSync(fname, csv);

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ap-south-1

      - name: Upload CSV to S3 with date
        run: |
          FILE=pr-report-$(date +%F).csv
          aws s3 cp $FILE s3://${{ secrets.S3_BUCKET }}/$FILE

      # Generate today's filename and make it reusable
      - name: Set report filename
        id: fname
        run: echo "file=pr-report-$(date +%F).csv" >> $GITHUB_OUTPUT

      # Send PR report email
      - name: Send PR report email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_FROM }}
          password: ${{ secrets.MAIL_PASS }}
          subject: "Daily PR Report - ${{ steps.fname.outputs.file }}"
          from: ${{ secrets.MAIL_FROM }}
          to: ${{ secrets.MAIL_TO }}
          body: |
            Hello,
            
            Attached is today's PR activity report.
            
            - GitHub Actions
          attachments: ${{ steps.fname.outputs.file }}

