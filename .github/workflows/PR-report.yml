name: PR Daily Checklist (SES)

on:
  schedule:
    - cron: "20 6 * * *"     # Runs daily 06:20 UTC (~11:50 IST)
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch PR data (today only)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { writeFileSync } = require('fs');

            // UTC start of today
            const start = new Date();
            start.setUTCHours(0,0,0,0);

            let page = 1;
            let all = [];

            while (true) {
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                per_page: 100,
                page
              });
              if (!prs.data.length) break;
              all.push(...prs.data);
              page++;
            }

            // Filter PRs updated today only
            const todays = all.filter(p => {
              const ts = new Date(p.updated_at);
              return ts >= start;
            });

            let csv = "PR_Number,Title,Source,Target,State,Environment,Author,MergedAt,UpdatedAt\n";
            todays.forEach(pr => {
              const src = pr.head.ref;
              const tgt = pr.base.ref;
              const env = tgt === "main" || tgt === "master" ? "docker" : "dev";
              const merged = pr.merged_at ? "merged" : pr.state;
              csv += `${pr.number},"${pr.title}",${src},${tgt},${merged},${env},${pr.user.login},${pr.merged_at},${pr.updated_at}\n`;
            });

            writeFileSync("pr-report.csv", csv);

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-report
          path: pr-report.csv

      - name: Configure AWS (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3
        run: |
          aws s3 cp pr-report.csv s3://${{ secrets.S3_BUCKET }}/pr-report-$(date +%Y-%m-%d).csv

      - name: Send Email via SES
        run: |
          aws ses send-email \
            --from "${{ secrets.MAIL_FROM }}" \
            --destination "ToAddresses=${{ secrets.MAIL_TO }}" \
            --message "Subject={Data='Daily PR Report'},Body={Text={Data='Attached is today\"s PR Report'}}" \
            --attachments "pr-report.csv"
        continue-on-error: true
