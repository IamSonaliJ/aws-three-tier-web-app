name: PR Report Export

# Trigger manually
on:
  workflow_dispatch:

# OIDC permissions
permissions:
  id-token: write
  contents: read

jobs:
  export:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout the repo
      - name: Checkout
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Fetch PR data and create CSV
      - name: Fetch PR data
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { writeFileSync } = require('fs');
            let page = 1;
            let all = [];
            while(true){
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                per_page: 100,
                page
              });
              if(prs.data.length === 0) break;
              all.push(...prs.data);
              page++;
            }
            let csv = "PR_Number,Title,Source,Target,State,Environment,Author,MergedAt\n";
            all.forEach(pr=>{
              const src = pr.head.ref;
              const tgt = pr.base.ref;
              const env = tgt === "main" || tgt === "master" ? "docker" : "dev";
              const merged = pr.merged_at ? "merged" : pr.state;
              csv += `${pr.number},"${pr.title}",${src},${tgt},${merged},${env},${pr.user.login},${pr.merged_at}\n`;
            });
            writeFileSync("pr-report.csv", csv);

      # 3Ô∏è‚É£ Configure AWS credentials via OIDC
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::632718277269:role/OIDC-PR-S3
          aws-region: ap-south-1

      # 4Ô∏è‚É£ Debug: Check file exists
      - name: Debug CSV
        run: |
          echo "CSV file contents:"
          cat pr-report.csv
          ls -lh

      # 5Ô∏è‚É£ Upload CSV to S3
      - name: Upload PR report to S3
        run: |
          echo "Uploading CSV to S3..."
          aws s3 cp pr-report.csv s3://pr-daily-report-bucket/pr-report.csv --debug

      # üü¢ SEND EMAIL STEP
      - name: Send PR report email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.MAIL_FROM }}
          password: ${{ secrets.MAIL_PASS }}
          subject: "PR Report Export"
          from: "${{ secrets.MAIL_FROM }}"
          to: "${{ secrets.MAIL_TO }}"
          body: "Hello,\n\nPR report is generated and uploaded to S3.\n\n- GitHub Actions"
          attachments: pr-report.csv
