
name: CI Validation Pipeline


on:
  pull_request:
    branches:
      - main


jobs:
  validate:
    name: Infra & Secrets Validation
    runs-on: ubuntu-latest


    env:
      AWS_REGION: ap-south-1


    steps:
      # Checkout Code
      - name: Checkout Code
        uses: actions/checkout@v4


      # AWS Authentication using GitHub OIDC
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_CHECKLIST_ROLE }}
          aws-region: ${{ env.AWS_REGION }}


      # Verify IAM Role (Check who is logged in)
      - name: Verify IAM Role
        run: |
          aws sts get-caller-identity
      # âœ… Verify EC2 Instance ID
      - name: Verify EC2 Instance
        run: |
          aws ec2 describe-instances \
            --instance-ids ${{ secrets.INSTANCE_ID }} \
            --query "Reservations[].Instances[].InstanceId"




      # Verify DEV Secrets
      - name: Verify DEV Secrets
        if: github.base_ref == 'dev'
        run: |
          aws secretsmanager describe-secret \
            --secret-id dev/app/secrets


      # Verify PROD Secrets
      - name: Verify PROD Secrets
        if: github.base_ref == 'main'
        run: |
          aws secretsmanager describe-secret \
            --secret-id prod/app/secrets


      # Verify ECR Repository
      - name: Verify ECR Repository
        run: |
          aws ecr describe-repositories \
            --repository-names dev/own-node-backend


      # Verify RDS Instance
      - name: Verify RDS Instance
        run: |
          aws rds describe-db-instances \
            --query "DBInstances[].DBInstanceIdentifier"


      # Validation Complete
      - name: Validation Complete
        run: echo " IAM, Secrets, ECR, and RDS validation successful"







 
